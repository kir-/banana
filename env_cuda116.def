Bootstrap: docker
From: nvidia/cuda:11.6.0-runtime-ubuntu20.04
Stage: build

%files
    requirements.txt requirements.txt

%post
    apt-get update && \
        apt-get -y upgrade && \
        apt-get install -y wget && \
        apt-get install -y libxrender1 && \
        apt-get install -y libxtst6
    wget --quiet https://repo.anaconda.com/miniconda/Miniconda3-latest-Linux-x86_64.sh -O ~/miniconda.sh
    /bin/bash ~/miniconda.sh -b -p /opt/conda
    export PATH=/opt/conda/bin:$PATH
    conda init
    # conda install python=3.8.0
    conda install -c conda-forge rdkit
    conda install libgcc
    conda install pytorch torchvision torchaudio cudatoolkit=11.6 -c pytorch -c conda-forge
    conda install -c dglteam dgl-cuda11.6
    pip install -r requirements.txt

%environment
    export PATH=/opt/conda/bin:$PATH
    export LD_LIBRARY_PATH=$LD_LIBRARY_PATH:/opt/conda/lib

%runscript
    python $@
